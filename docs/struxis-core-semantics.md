# Struxis Structure 语义规范

本文件用于统一 `struxis` 中结构层（`SBar -> CBar -> Swing -> Trend`）的定义与关系，作为：
- 回放验证（CSV/tick）基准；
- 测试断言口径；
- 可视化图例与术语约束。

实现推进与验收顺序见：`docs/struxis-core-task-roadmap.md`

## 1. 分层关系

结构层级按输入到抽象递进：

1. `SBar`：底层周期 K 线（tick 聚合或 CSV）
2. `CBar`：对 `SBar` 去包含后的结构 K 线
3. `Swing`：基于 `CBar` 分型构造的二次波段结构
4. `Trend`：基于 `Swing` 的同向连接结构

约束：上层结构不得跳过下层直接构造。

---

## 2. SBar（原始周期K线）

`SBar` 是结构计算的最底层输入，来源有两类：
- 由 `tick` 聚合得到某周期 bar；
- CSV 直接提供该周期 bar。

`SBar` 只表达原始行情，不承载缠论结构语义。

---

## 3. CBar（去包含结构K线）

`CBar` 由 `SBar` 按“包含关系合并”规则生成，目标是消除包含噪声，形成可用于分型识别的结构序列。

### 3.1 方向型 CBar

- **上升 K 线**：高点抬高、低点也抬高；
- **下降 K 线**：高点降低、低点也降低。

### 3.2 分型

分型由连续三条 `CBar` 组成：

- **顶分型（Top Fractal）**：中间 `CBar` 的高点最高，左右两条 `CBar` 的高点都低于中间；
- **底分型（Bottom Fractal）**：中间 `CBar` 的低点最低，左右两条 `CBar` 的低点都高于中间。

> 注：该定义为本项目结构语义的核心，不以视觉主观判断替代。

---

## 4. Swing（二次结构，近似“笔”）

`Swing` 基于 `CBar` 序列与分型构造。

定义口径：
- 以某个底分型开始，至后续顶分型结束（上行 swing）；
- 以某个顶分型开始，至后续底分型结束（下行 swing）；
- 同时满足项目内的波动幅度/有效性限制（非机械连分型）。

重叠/不重叠判定口径（任务3关键约束）：
- 分型区间按“分型三根整体包络”计算，而非仅中间一根 `CBar`；
- 即 `fractal_high = max(left.high, middle.high, right.high)`，`fractal_low = min(left.low, middle.low, right.low)`；
- 起止分型区间完全分离（无交集）可直接确认 swing；
- 若仅边界接触或仍有重叠，则进入幅度比例与最小间隔等附加门槛再判断有效性。

因此 `Swing` 是“有效波段”，不是所有分型对都构成 swing。

### 4.1 Swing 状态机（已固化）

`Swing` 不再仅有 completed/未完成二态，而是三态：

- `Forming`：当前方向正在延展；
- `PendingReverse`：已出现反向候选，等待后继 swing 证明其有效；
- `Confirmed`：已被后继反向 swing 确认终结。

确认原则：
- 一个 swing 的最终确认依赖“下一条反向 swing 成立”；
- 反向候选若后续失败，则应回退并恢复前一 swing 延续。

可视化口径：
- `Confirmed`：实线；
- `PendingReverse`：虚线；
- `Forming`：点线。

---

## 5. Trend（趋势结构）

`Trend` 以 `Swing` 为输入，将同向 `Swing` 连接形成更高一级结构：

- 同向 `Swing` 串联形成一个 `Trend`；
- 按方向分为 **上升趋势** 与 **下降趋势**。

`Trend` 的起点是某个 swing，终点由后续 swing 关系决定。

---

## 6. KeyZone（关键交易区域）

`KeyZone` 表达交易关注的关键价格区域（支撑/压力候选带），用于：
- 评估价格与关键区域的互动；
- 支持信号判断与后续交易决策。

### 6.1 基本属性

- `origin`（来源）：`Swing / Trend / Channel / Ema` 等。
  - 来源实体的边界提供关键区的初始支撑/压力依据。
- `orientation`（方向）：`Horizontal / Trendline / Channel`。
  - 用于表达该关键区预期生效的方向特征。

### 6.2 区间划定原则

`KeyZone` 的区间并非仅由上层结构直接投影，还需参考底层 `SBar`：
- 结合相邻 `SBar` 之间的影线关系（上影/下影）修正区间边界；
- 通过实体与影线在区间内的触达情况，增强关键区边界的有效性。

可执行口径：
- 先由 `origin` 结构给出候选上下边界；
- 再以 `SBar` 影线互动对上下边界进行细化；
- 最终输出用于后续行为判断（触达、接受、拒绝、二次推动等）。

---

## 7. SD（SupplyDemand，供需评估）

`SD` 用于评判一段行情的强弱关系，核心关注：
- 主导力量（推动方向的一侧）强弱；
- 对抗力量（反向制衡一侧）强弱；
- 二者对比形成的供需优势状态。

### 7.1 输入

`SD` 输入可以是以下任意形态（按实现场景选取）：
- 一段 `SBar` 序列（最常见）；
- `Swing` 结构片段；
- `Trend` 结构片段。

### 7.2 输出

`SD` 输出由两层组成：
- **总评**：整体供需强弱结论（如评分/阶段）；
- **分因子评估**：主导与对抗关系拆解后的细分因子结果。

输出用途：供策略层直接使用（过滤、确认、打分、仓位调节等）。

---

## 8. 关系示意

`SBar`（原始）
→ 去包含合并
→ `CBar`（方向+分型）
→ 分型约束 + 波动有效性
→ `Swing`（有效波段）
→ 同向连接
→ `Trend`（趋势段）
→ 派生关键区
→ `KeyZone`（来源+方向+区间）
→ 供需评估
→ `SD`（总评 + 分因子）

---

## 9. 工程使用建议

1. **测试**：
   - 先测 `CBar` 分型正确性；
   - 再测 `Swing` 有效性与方向；
   - 最后测 `Trend` 连接规则。
   - `KeyZone` 需单独验证：来源归属、方向属性、区间边界与 `SBar` 影线细化一致性。
   - `SD` 需验证：总评稳定性、分因子可解释性、不同输入形态下输出一致性趋势。
2. **可视化**：
   - K 线图可同时叠加 `CBar/Swing/Trend/KeyZone`，确保语义一致。
   - 可选叠加 `SD` 总评/分因子面板用于策略联调。
3. **回放调试**：
   - CSV 逐条回放时，优先检查每个层级的输出数量与边界关系。
   - 在关键波段末端记录 `SD` 输出，便于和策略触发点对齐。

---

## 10. 术语一致性（必须）

- `SBar`：原始周期K线
- `CBar`：去包含结构K线
- `Top/Bottom Fractal`：顶/底分型
- `Swing`：二次波段结构（近似笔）
- `Trend`：同向 swing 连接结构
- `KeyZone`：关键区域（来源 + 方向 + 底层影线细化）
- `SD`：供需评估（总评 + 分因子，用于策略层）

若实现细节需要扩展，必须保持以上语义不变，避免跨模块口径漂移。
