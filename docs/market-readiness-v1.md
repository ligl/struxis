# Market 生产就绪清单 v1

> 范围：`broker -> market -> downstream` 行情接收与分发链路。  
> 目标：从“可运行骨架”推进到“可上线运行”。

## 设计硬原则（长期生效）

`market` 设计与实现必须同时满足以下四条：

1. 低延时（Low Latency）
2. 高并发（High Concurrency）
3. 无锁设计优先（Lock-Free First）
4. 零成本抽象（Zero-Cost Abstractions）

说明：以上原则优先级高于局部实现便利性；若出现冲突，默认选择更符合四条原则的实现路径。

## 当前结论

当前已具备：

- 多下游并发分发（fan-out）
- broker 与 market 解耦
- ingress 队列与基础指标
- 端到端可运行链路

当前仍缺：

- 真实交易所链路稳定性（重连/心跳/恢复）
- 可量化性能指标体系（延迟、吞吐、丢包）
- 背压与过载策略
- 生产可观测与故障处置

---

## P0（必须完成）

### 1) 实盘连接可靠性

- 交付项
  - `broker` 实现真实 WebSocket 连接生命周期：`connect/reconnect/backoff/heartbeat`。
  - 断线重连后自动恢复订阅。
  - 网络抖动与临时失败可自动自愈。
- 验收标准
  - 人工断网 30s 后自动恢复。
  - 重连后 60s 内持续接收数据，无 panic。

### 2) 背压与丢包策略

- 交付项
  - ingress 满载时策略可配置：`drop_newest | drop_oldest | block`。
  - 每种策略产出明确指标计数。
- 验收标准
  - 压测下系统行为可预测；
  - `dropped_total`、`queue_fill_ratio`、`backpressure_events` 可持续观测。

### 3) 延迟与吞吐基线

- 交付项
  - 建立端到端指标：`ingest_latency_us`、`fanout_latency_us`、`e2e_latency_us`。
  - 统计 p50/p95/p99 与峰值吞吐。
- 验收标准（建议目标）
  - 单机 mock 压测下：p99 e2e < 5ms（同进程多下游）。
  - 无持续增长队列（稳态下 ingress 不单调上涨）。

### 4) 幂等与顺序保证

- 交付项
  - 增加序列字段（或可比较时间戳）并做乱序检测。
  - 明确下游读取语义：至少一次投递 + 乱序可检测。
- 验收标准
  - 可输出乱序/重复计数；
  - 下游可基于字段去重。

---

## P1（强烈建议）

### 5) 可观测性

- 交付项
  - 暴露关键指标（Prometheus 或等价）与结构化日志。
  - 指标最小集：
    - `market_published_total`
    - `market_dropped_total`
    - `market_ingress_len`
    - `market_subscriber_count`
    - `broker_reconnect_total`
- 验收标准
  - 故障发生时可在 5 分钟内定位到“连接/队列/分发”哪一段。

### 6) 多品种多频道扩展

- 交付项
  - 同时运行多 symbol、多 interval 的路由与隔离。
  - 活跃频道管理与自动清理。
- 验收标准
  - 多频道压测下无明显串扰；
  - 无活跃订阅时频道可回收。

### 7) 资源与线程模型

- 交付项
  - 明确线程拓扑：接入线程、分发线程、消费线程。
  - 可选 CPU 亲和性绑定。
- 验收标准
  - 满载下 CPU 使用可解释；
  - 无异常线程增长。

---

## P2（增强项）

### 8) 持久化与恢复

- 交付项
  - 可选写入（WAL 或批量落盘）用于回放与审计。
  - 异常重启后恢复策略说明。
- 验收标准
  - 重启后可恢复到最近一致状态。

### 9) 灰度与安全开关

- 交付项
  - 运行时配置支持动态开关：限流、暂停订阅、降级策略。
- 验收标准
  - 高负载时可一键降级而不宕机。

---

## 实施顺序（建议）

1. P0-1 连接可靠性
2. P0-2 背压策略
3. P0-3 延迟基线压测
4. P0-4 顺序与幂等
5. P1 可观测性

---

## 完成定义（DoD）

满足以下条件即认为“市场系统可上线试运行”：

- P0 全部完成并通过验证；
- 关键指标可观测；
- 连续 24h 稳定运行（无 panic、无不可恢复断流）；
- 压测报告记录并可复现。
