# Trading System Thinking

## 1. 目标与范围

### 1.1 系统目标
- 以K线为基础观测对象。
- 以攻守双方力量大小为统一分类依据。
- 为每个周期构建统一结构链：`K -> SBar -> CBar -> Swing -> Trend`。
- 在结构之上构建 KeyZone 与 SupplyDemand（SD）评估。
- 输出可执行行为：开多、平多、开空、平空、等待。

### 1.2 范围内能力（In Scope）
- 多周期结构识别与状态更新。
- 关键区识别与生命周期管理。
- 任意K线窗口的供需强弱评估。
- 结构信号 + 强弱评估联合决策。

### 1.3 非目标（Out of Scope）
- 不在本阶段定义复杂资金管理/组合优化。
- 不在本阶段绑定特定交易网关细节。
- 不在本阶段引入难以解释的黑盒模型。

---

## 2. 核心术语与统一约定

### 2.1 攻守力量（统一语言）
- 攻方：推动价格朝某方向持续扩展的一方。
- 守方：抑制扩展并制造回撤/震荡的一方。
- 强弱评估必须可解释，不能仅有黑盒总分。

### 2.2 周期与对齐
- 每个周期独立维护完整链路：K/SBar/CBar/Swing/Trend。
- 跨周期只做“状态对齐与约束”，不互相覆盖底层事实。

### 2.3 规则状态标签（建议）
- Draft：规则草案。
- Validated：历史验证通过。
- Live：已用于实时决策。

---

## 3. 基础 Pipeline 规范

> 本节用于定义每一层“输入 -> 转换规则 -> 输出 -> 失效/回溯”。

### 3.1 K（原始K线）
- 输入：交易所/数据源原始K线。
- 最小字段：datetime/open/high/low/close/volume/open_interest。
- 质量门禁：时间单调、价格字段有效、缺失值策略。

待补充：
- [ ] 品种级异常规则（涨跌停、夜盘切换、主力切换）。
- [ ] 数据修复优先级（丢弃/插值/回填）。

### 3.2 SBar（标准化K）
- 输入：K。
- 转换：标准化字段、ID分配、基础指标挂载（如EMA）。
- 输出：可序列化、可追溯的标准K对象。
- 回溯触发：历史修复、补包、主力切换回填。

待补充：
- [ ] 指标最小集合（EMA/ATR/其他）。
- [ ] 指标重算窗口与性能上限。

### 3.3 CBar（包含处理后K）
- 输入：SBar。
- 转换：处理包含关系，得到“无包含”序列；同步分形判定。
- 输出：CBar序列 + 分形标签。
- 回溯触发：包含关系导致历史段重算。

待补充：
- [ ] 包含处理方向判定细则。
- [ ] 分形确认与失效条件。

### 3.4 Swing（波段）
- 输入：CBar与分形。
- 转换：按成段规则识别波段，维护进行中与已完成状态。
- 输出：Swing序列（方向、跨度、高低点、强度统计）。
- 回溯触发：前置分形失效、包含重算连锁。

待补充：
- [ ] 成段硬条件（最小跨度/最小幅度/缺口条件）。
- [ ] 波段延续与终结的优先级。

### 3.5 Trend（趋势）
- 输入：Swing序列。
- 转换：基于特征序列识别趋势与转折。
- 输出：Trend序列（方向、状态、跨度、强度统计）。
- 回溯触发：Swing回溯、转折点重判。

待补充：
- [ ] 趋势启动条件（至少3段重叠等）。
- [ ] pullback 与主趋势冲突处理。

---

## 4. KeyZone 规范

### 4.1 来源
- Swing来源关键区。
- Trend来源关键区。
- （可选）Channel/EMA动态关键区。

### 4.2 生命周期
- Create：首次创建。
- Update：触碰计数/边界微调。
- Invalidate：被有效突破或时间失效。
- Archive：保留用于复盘。

### 4.2.1 价格-关键区行为四态（完备系统）
- Approach：价格靠近关键区但未触及。
- Touch：首次触及关键区边界。
- Accept：进入关键区并停留/吸收。
- Reject：触及后快速反向离开。

状态机（FSM）约束：
- 未触及必为 Approach。
- 触及后必须进入 Touch。
- Touch 后只能转向 Accept 或 Reject。
- 所谓“直接穿透”在工程上归类为“快速 Accept -> Break”。

工程事件建议：
- `on_approach`
- `on_touch`
- `on_accept`
- `on_reject`

### 4.3 输出字段（建议）
- timeframe, origin_type, orientation
- upper/lower
- touch_count, last_touch_id
- sbar_start_id, sbar_end_id

待补充：
- [ ] 有效触碰定义（默认：影线或实体交叉区域边界且停留>=1 bar）。
- [ ] 失效阈值（默认：突破幅度 + 持续根数 + 回踩失败联合确认）。

---

## 5. SupplyDemand（SD）规范

> 目标：评估任意一段K线谁在主导、主导效率如何、是否正在被侵蚀。

### 5.1 输出设计
- 总分：`sd_score ∈ [-1, 1]`（建议，负值偏空，正值偏多）。
- 正交分量：
  - dominance（主导性）
  - efficiency（效率）
  - sustainability（可持续性）
  - volatility_adjustment（波动修正）
- 解释文本：可读原因摘要（用于日志/回测报告）。

补充：SD 的任何输出都是“概率性解释”，不是直接交易指令。

### 5.2 评估对象
- 任意窗口（k-window）。
- 单个Swing。
- 单个Trend。

### 5.3 归一化要求
- 无量纲，可跨品种/跨周期比较。
- 避免单因子决定总分。
- 因子缺失时要可降级输出。

待补充：
- [ ] 每个因子的数学定义。
- [ ] 聚合权重与动态调权规则。
- [ ] 稳健性约束（极端波动/低流动性）。

### 5.4 三层九因子模型（来自盘中实时判断）

第一层：即时K线强弱（Momentum Micro-Structure）
- F1 拒绝/接受（Rejection vs Acceptance）
- F2 推进效率（Advancement Efficiency）
- F3 动能一致性（Momentum Consistency）

第二层：价量持仓三联动（Vol-OI Structure）
- F4 成交量支持（Volume Confirmation）
- F5 持仓量性质（OI Nature：增仓/减仓/换手）
- F6 价量持仓共振（Vol + OI Alignment）

第三层：结构强弱（Trend-Swing Structure）
- F7 当前 Swing 力度相对前一 Swing 的强弱
- F8 关键位反应方式（KeyZone Reaction）
- F9 多周期结构一致性（Multi-Timeframe Alignment）

### 5.5 SD 核心判断原子（A~I）

主导方向（谁主导）
- A 主动性是否存在
- B 推进方向一致性
- C 回撤中的角色关系（反击还是喘气）

主导效率（主导质量）
- D 时间效率
- E 实体/影线效率
- F 成交/持仓“性价比”

主导侵蚀（可持续性）
- G 同方向推进边际恶化
- H 关键位行为失配（本该赢却赢不了）
- I 对手反应质量提升

建议状态输出：
- 主导稳定 / 主导减弱 / 主导临界 / 主导失效

### 5.6 SD 起点（阶段重置）
- 起点1：结构转折点（Trend Flip / Swing Major）。
- 起点2：量能集聚点（Volume Cluster / OI Surge）。

---

## 6. Decision 规范

### 6.1 行为集合
- open_long
- close_long
- open_short
- close_short
- wait

### 6.2 决策输入
- 结构状态：SBar/CBar/Swing/Trend。
- 区域状态：KeyZone。
- 力量状态：SD结果。
- 风险约束：仓位、交易时段、滑点、手续费。

### 6.3 决策规则框架（模板）
- 前置条件（必须满足）。
- 触发条件（可触发信号）。
- 否决条件（有则撤销）。
- 执行参数（价格/数量/有效期）。

待补充：
- [ ] 同时出现多空信号时的冲突优先级。
- [ ] 平仓优先级是否高于开仓。
- [ ] 信号去抖（冷却时间/重复触发抑制）。

### 6.4 盘中 10 秒扫描门禁（执行前 checklist）
- 3根K行为是否统一。
- 当前是 Accept 还是 Reject。
- 推进速度是快还是慢。
- 成交量是否支持方向。
- OI 是增仓/减仓/换手。
- 价量持仓是否共振。
- 当前 Swing 力度是否强于前一段。
- 关键位反应是否符合预期。
- 多周期方向是否一致。

执行门禁建议：
- 一致项 >= 7：允许执行。
- 一致项 <= 4：禁止执行。
- 矛盾项 >= 3：标记高假突破风险。

### 6.5 Second Push 原则（默认启用）
- 第一次突破视为“试探”，默认不追。
- 优先等待“突破 -> 回踩（浅/缓/弱）-> 二次突破增强”再执行。
- 若第一次突破后快速回收并反向实体穿回，判定 Breakout Failure，优先风控。

---

## 7. 多周期联动规范

### 7.1 联动原则
- 高周期给方向约束。
- 中周期给交易机会。
- 低周期给执行时机。

### 7.2 冲突处理
- 高低周期冲突时：默认降风险，不强开仓。
- 同向共振时：允许提高信号等级。
- 低周期单独强信号，不得覆盖高周期关键位压制事实。

待补充：
- [ ] 15m/1h/1d 的具体门限与优先级表。

---

## 8. 约束与验证

### 8.1 工程约束
- 实时性能：避免每根bar全量重算。
- 可复现：同输入必须同输出。
- 可观测：关键事件可追踪。

### 8.2 验证清单
- 单元测试：分形、成段、转折、关键区、SD。
- 回放一致性：实时增量 vs 离线全量结果一致。
- 回测一致性：Python基线 vs Rust实现逐项对比。

### 8.3 失败安全
- 数据异常时输出 `wait`。
- 不满足最小信息条件时禁止开仓。
- KeyZone 状态不明（Touch 后未确认 Accept/Reject）时禁止追突破。
- SD 分量冲突明显（方向/效率/可持续性互相否定）时降级为 `wait`。

---

## 9. 资料喂入协议（你后续可直接用）

你每次补充内容时，建议按以下模板贴入：

```text
[章节] 例如：5.3 归一化要求
[状态] Draft / Validated / Live
[规则] 明确规则文本
[例子] 至少1个正例 + 1个反例
[验证] 如何在历史数据上验证
```

---

## 10. 当前结论（初版）

- 本系统是“结构识别 + 供需强弱评估”的统一引擎。
- 结构链路为事实层，SD为解释层，Decision为执行层。
- Struxis 迁移应按“先一致性、后性能优化”推进。

---

## 11. 个人交易原则（记忆锚点）

> 来源：`docs/assets/我的交易基石_.md`。
> 作用：作为系统设计与实现的上位约束，后续新增规则不得与本节冲突。

### 11.1 核心世界观
- 交易是“自我与市场交互融合统一”的过程，不是单向预测。
- 市场是不确定系统，交易者职责是识别并利用“阶段性比较优势”。
- 机会与风险相伴而生：先识别机会，再评估风险，再执行。

### 11.2 方法论锚点
- 以结构为基础，供求为核心。
- 趋势由结构定义，是供求持续占优的外在表达。
- 决策必须动态更新：对供求强弱变化进行持续再评估。

### 11.3 执行三原则
- 我为市场立法，我服从我的立法。
- 价格以趋势方式演变。
- 截断亏损，让利润奔跑。

### 11.4 心智与纪律约束
- 不将单笔盈亏与自尊绑定。
- 决策前固定三问：
  - 我的系统怎么说？
  - 如果失败我是否可接受？
  - 这次决策让我更自尊还是更内耗？
- 冲动与犹疑都视为“预警信号”，不是敌人；需要规则化处理。

### 11.5 对系统实现的硬约束（Engineering Guardrails）
- `Decision` 层必须可解释，不能输出“无理由信号”。
- `SupplyDemand` 必须支持“主导性/效率/可持续性”三维解释。
- 多周期冲突时默认降风险，不做强预测式开仓。
- 缺失数据或条件不足时，默认输出 `wait`。

### 11.6 本节维护规则
- 新增策略规则时，需标注其对应的原则条目（11.1~11.5）。
- 若规则与本节冲突，以本节为准并回退实现。

---

## 12. KeyZone 行为学（六类典型行为）

在四态之上，记录六类高价值行为模式：
- Strong Rejection（快速拒绝）
- Weak Rejection（缓慢拒绝）
- Strong Acceptance（强势接受）
- Weak Acceptance（弱势接受）
- Second Push（突破-回踩-再突破）
- Breakout Failure（突破失败）

优先级规则：
- Breakout Failure 优先级高于普通突破信号。
- Strong Acceptance + 多周期同向时，才允许提高仓位等级。

---

## 13. Struxis 实现映射（V1）

目标：把上述规则映射到 `Struxis`（当前目录：`struxis`）中可迭代实现。

- `struxis/src/keyzone.rs`
  - 增加 `KeyZoneState`：Approach/Touch/Accept/Reject
  - 增加行为日志 `reaction_list`

- `struxis/src/sd.rs`
  - 增加 `SdFactorSnapshot`（F1~F9）
  - 增加 `SdAtomSnapshot`（A~I）
  - 输出 `SdStage`：Stable/Weakening/Critical/Failed

- `strategy/src/decision.rs`
  - 接入 10 秒扫描门禁
  - 接入 Second Push 规则
  - 冲突默认 `wait`

- `struxis/src/mtc.rs`
  - 在 `MtcNewBar` 后触发：`KeyZone FSM -> SD更新`，并向策略层提供分析快照

---

## 14. 当前落地优先级（执行顺序）

1. 在 Struxis 侧实现 KeyZone 四态 FSM。
2. 在 Struxis 侧实现 SD 三分量 + F1~F3（先做微观层）。
3. 在 `strategy` 侧接入 Decision 门禁（含 10 秒扫描阈值）。
4. 再扩展 F4~F9 与 A~I 全量解释。
